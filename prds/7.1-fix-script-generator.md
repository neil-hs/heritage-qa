# PRD 7.1: Fix Script Generator

## Overview
Generate shell scripts to fix correctable issues (EXIF tags, etc.).

## Deliverables
- `src/fixes/fix-script-generator.ts`

## Interface

```typescript
export interface FixScriptOptions {
  outputPath: string;
  dryRun?: boolean; // add echo instead of execute
  backup?: boolean; // backup files before modifying
  batchSize?: number; // commands per script, default all
}

export interface FixableIssue {
  filepath: string;
  fixType: 'exif_tag' | 'color_space' | 'icc_profile';
  tag?: string;
  currentValue?: string;
  targetValue: string;
}

export async function generateFixScript(
  db: Database,
  runId: number,
  options: FixScriptOptions
): Promise<string>;

export function getFixableIssues(
  db: Database,
  runId: number
): Promise<FixableIssue[]>;
```

## Script Format

```bash
#!/bin/bash
# Heritage QC Fix Script
# Generated: 2025-01-19
# Run: v1
# Fixes: 5 EXIF tag issues
#
# Review this script before running!
# To execute: chmod +x fix_exif_v1.sh && ./fix_exif_v1.sh

set -e

echo "Fixing 5 images..."

# Backup originals (optional)
# mkdir -p backups/

# Fix 1: IMG_0100.tif - Add Artist tag
exiftool -overwrite_original -Artist="Museum Archives" "/path/to/IMG_0100.tif"

# Fix 2: IMG_0101.tif - Add Artist tag
exiftool -overwrite_original -Artist="Museum Archives" "/path/to/IMG_0101.tif"

# ... more fixes ...

echo "Done! Fixed 5 images."
echo "Re-run validation to verify fixes."
```

## Fix Types

### EXIF Tag (Missing)
```bash
exiftool -overwrite_original -TagName="value" "file.tif"
```

### EXIF Tag (Wrong Value)
```bash
exiftool -overwrite_original -TagName="correct_value" "file.tif"
```

### ICC Profile
```bash
exiftool -overwrite_original "-icc_profile<=profile.icc" "file.tif"
```

### Color Space
```bash
# Convert using ImageMagick (if installed)
convert "file.tif" -colorspace sRGB "file.tif"
```

## Safety Features

- Comments explaining each fix
- Dry-run mode (echo only)
- Optional backup before modify
- Set -e to stop on error
- Reviewable before execution
- **Rigorous shell escaping** (see below)

## Shell Escaping (Security Critical)

File paths in archives can contain special characters (spaces, quotes, $, etc.).
Use `shell-quote` or equivalent to prevent injection.

```typescript
import { quote } from 'shell-quote';

function escapeForShell(filepath: string): string {
  // shell-quote handles: spaces, quotes, $, `, !, etc.
  return quote([filepath]);
}

// Example output:
// "/path/with spaces/file.tif" → '"/path/with spaces/file.tif"'
// "/path/with'quote.tif" → '"/path/with'\''quote.tif"'
// "/path/$variable.tif" → '"/path/\$variable.tif"'
```

### Required Dependency
```json
{
  "dependencies": {
    "shell-quote": "^1.8.1"
  }
}
```

### Never Do This
```typescript
// DANGEROUS - vulnerable to injection
const cmd = `exiftool -Artist="${value}" ${filepath}`;

// SAFE - properly escaped
const cmd = `exiftool -Artist=${quote([value])} ${quote([filepath])}`;
```

## Success Criteria
- [ ] Generate valid bash scripts
- [ ] Scripts executable and work
- [ ] Proper escaping of paths/values
- [ ] Dry-run mode works
- [ ] Backup option works
- [ ] Unit tests

## Dependencies
- PRD 1.2 (database)
- PRD 5.4 (fixable issues from validation)
