# PRD 1.4: Progress Tracker Utility

## Overview
Real-time progress tracking for long-running operations (EXIF extraction, JHOVE validation).

## Deliverables
- `src/utils/progress-tracker.ts`
- Progress JSON file format

## Interface

```typescript
export interface ProgressState {
  operation: string;
  phase: string;
  total: number;
  completed: number;
  failed: number;
  currentFile?: string;
  startedAt: string;
  updatedAt: string;
  estimatedCompletion?: string;
  errors: ProgressError[];
}

export interface ProgressError {
  file: string;
  error: string;
  timestamp: string;
}

export class ProgressTracker {
  constructor(outputPath: string, operation: string);

  start(total: number, phase?: string): void;
  update(completed: number, currentFile?: string): void;
  increment(currentFile?: string): void;
  fail(file: string, error: string): void;
  complete(): void;

  getState(): ProgressState;
  getPercentage(): number;
  getETA(): Date | null;
}
```

## progress.json Format

```json
{
  "operation": "exif-extraction",
  "phase": "extracting",
  "total": 500,
  "completed": 123,
  "failed": 2,
  "currentFile": "IMG_0124.tif",
  "startedAt": "2025-01-19T10:00:00Z",
  "updatedAt": "2025-01-19T10:05:32Z",
  "estimatedCompletion": "2025-01-19T10:15:00Z",
  "errors": [
    {"file": "IMG_0050.tif", "error": "Cannot read EXIF", "timestamp": "..."}
  ]
}
```

## Behavior
- Write to file on every `update()` call (debounced to 500ms)
- Calculate ETA based on moving average of last 20 items
- Thread-safe file writes (atomic rename)
- Auto-cleanup on `complete()`
- **Signal handling for graceful shutdown** (see below)

## Signal Handling (Graceful Shutdown)

Long-running operations may be interrupted (Ctrl+C, system shutdown).
Handle SIGINT/SIGTERM to save state before exit.

```typescript
export function setupGracefulShutdown(
  progress: ProgressTracker,
  db?: Database
): void {
  const cleanup = async () => {
    console.log('\nInterrupted - saving progress...');

    // Save current progress state
    progress.saveCheckpoint();

    // Close database connection cleanly
    if (db) {
      await db.close();
    }

    console.log('Progress saved. Resume with --resume flag.');
    process.exit(0);
  };

  process.on('SIGINT', cleanup);
  process.on('SIGTERM', cleanup);
}
```

### Checkpoint Format

On interrupt, write checkpoint to progress.json:
```json
{
  "operation": "exif-extraction",
  "interrupted": true,
  "lastProcessedIndex": 523,
  "canResume": true
}
```

This prevents:
- Database locks from unclosed connections
- Corrupted progress files from partial writes
- Lost work that needs to be redone

## Usage Example

```typescript
const progress = new ProgressTracker('./progress.json', 'exif-extraction');
progress.start(500, 'scanning');

for (const file of files) {
  try {
    await extractExif(file);
    progress.increment(file);
  } catch (e) {
    progress.fail(file, e.message);
  }
}

progress.complete();
```

## Success Criteria
- [ ] Progress file updates in real-time
- [ ] ETA calculation accurate within 20%
- [ ] No file corruption on concurrent writes
- [ ] Handles 10,000+ items without memory issues
- [ ] Unit tests pass

## Dependencies
- PRD 1.1 (project setup)
