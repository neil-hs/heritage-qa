# PRD 3.3: Batch EXIF Processor

## Overview
Process large batches of images with progress tracking and database storage.

## Deliverables
- `src/extraction/batch-processor.ts`

## Interface

```typescript
export interface BatchOptions {
  chunkSize?: number; // default 100
  concurrency?: number; // default 1 (sequential for stability)
  onProgress?: (state: ProgressState) => void;
  resumeFrom?: number; // image ID to resume from
}

export interface BatchResult {
  processed: number;
  failed: number;
  skipped: number;
  errors: BatchError[];
  duration: number; // ms
}

export interface BatchError {
  filepath: string;
  error: string;
}

export async function processImages(
  db: Database,
  files: FileInfo[],
  options?: BatchOptions
): Promise<BatchResult>;

export async function resumeProcessing(
  db: Database,
  progressPath: string,
  options?: BatchOptions
): Promise<BatchResult>;
```

## Algorithm

```
1. Create validation run in DB
2. Split files into chunks of 100
3. For each chunk:
   a. Call exiftool batch extraction
   b. For each result:
      - Insert image record
      - Insert EXIF data
      - Update progress tracker
   c. Commit transaction
4. Update run as complete
5. Return summary
```

## Resume Capability

Store checkpoint in progress.json:
```json
{
  "lastProcessedIndex": 523,
  "runId": 1
}
```

On resume:
1. Read checkpoint
2. Query DB for processed files
3. Skip already processed
4. Continue from checkpoint

## Transaction Strategy

- Commit every chunk (100 images)
- On error: rollback current chunk, continue with next
- Log errors for retry

## Performance Targets

- 1,000 images in <10 minutes
- Memory: <500MB for 10,000 images
- DB writes: batch inserts

## Success Criteria
- [ ] Process 1,000 images with progress updates
- [ ] Resume after interruption
- [ ] Handle individual file errors gracefully
- [ ] Transaction safety (no partial chunks)
- [ ] Progress tracking accurate
- [ ] Performance targets met
- [ ] Integration tests

## Dependencies
- PRD 1.2 (database)
- PRD 1.4 (progress tracker)
- PRD 3.1 (exiftool)
- PRD 3.2 (file scanner)
