# PRD 1.2: Database Schema & SQLite Setup

## Overview
Create SQLite database schema and helper functions for all validation data.

## Deliverables
- `schemas/database.sql` - SQL schema
- `src/utils/db-schema.ts` - DB initialization & connection
- `src/utils/query-helpers.ts` - Common queries

## Tables

### images
```sql
CREATE TABLE images (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  filepath TEXT UNIQUE NOT NULL,
  filename TEXT NOT NULL,
  extension TEXT NOT NULL,
  file_type TEXT NOT NULL, -- TIFF, RAW, JPEG, PNG
  file_size INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### exif_data
```sql
CREATE TABLE exif_data (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  image_id INTEGER NOT NULL,
  tag_name TEXT NOT NULL,
  tag_value TEXT,
  FOREIGN KEY (image_id) REFERENCES images(id),
  UNIQUE(image_id, tag_name)
);
```

### validation_results
```sql
CREATE TABLE validation_results (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  image_id INTEGER NOT NULL,
  validation_run INTEGER NOT NULL,
  check_type TEXT NOT NULL, -- jhove, exif, dimension, color, naming
  status TEXT NOT NULL, -- pass, fail, warning, skip
  severity TEXT, -- critical, fixable, warning
  message TEXT,
  details TEXT, -- JSON
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (image_id) REFERENCES images(id)
);
```

### validation_runs
```sql
CREATE TABLE validation_runs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  version INTEGER NOT NULL,
  config_hash TEXT,
  started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME,
  total_images INTEGER,
  passed INTEGER,
  failed INTEGER
);
```

## Interface: db-schema.ts

```typescript
export interface Database {
  db: BunSQLiteDatabase;
}

export function initDatabase(dbPath: string): Database;
export function closeDatabase(db: Database): void;
export function resetDatabase(db: Database): void;
```

## Interface: query-helpers.ts

```typescript
export function insertImage(db: Database, image: ImageInput): number;
export function insertExifData(db: Database, imageId: number, exif: Record<string, string>): void;
export function insertValidationResult(db: Database, result: ValidationResultInput): number;
export function getImageByPath(db: Database, filepath: string): Image | null;
export function getFailedImages(db: Database, runId: number): Image[];
export function getValidationSummary(db: Database, runId: number): ValidationSummary;
```

## Success Criteria
- [x] Can create database file
- [x] All tables created with correct schema
- [x] CRUD operations work for all tables
- [x] Foreign key constraints enforced
- [x] Unit tests pass

## Dependencies
- PRD 1.1 (project setup)
