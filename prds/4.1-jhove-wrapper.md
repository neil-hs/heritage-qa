# PRD 4.1: JHOVE Wrapper (TIFF Validation)

## Overview
TypeScript wrapper for JHOVE CLI to validate TIFF file structure.

## Deliverables
- `src/validation/jhove.ts`

## Interface

```typescript
export interface JhoveResult {
  filepath: string;
  valid: boolean;
  wellFormed: boolean;
  status: 'valid' | 'not-valid' | 'not-well-formed';
  format?: string;
  version?: string;
  errors: JhoveError[];
  warnings: JhoveWarning[];
  rawXml?: string;
}

export interface JhoveError {
  message: string;
  offset?: number;
}

export interface JhoveWarning {
  message: string;
}

export interface JhoveOptions {
  timeout?: number; // ms, default 60000
  outputDir?: string; // for XML output
}

export async function validateTiff(
  filepath: string,
  options?: JhoveOptions
): Promise<JhoveResult>;

export async function validateTiffBatch(
  filepaths: string[],
  options?: JhoveOptions
): Promise<Map<string, JhoveResult>>;

export async function isJhoveInstalled(): Promise<boolean>;
export async function getJhoveVersion(): Promise<string>;
```

## JHOVE Command

```bash
# Single file
jhove -h xml -m TIFF-hul /path/to/image.tif

# Multiple files (single JVM invocation - reduces startup overhead)
jhove -h xml -m TIFF-hul /path/to/*.tif

# Output to file
jhove -h xml -m TIFF-hul -o output.xml /path/to/image.tif
```

## XML Parsing

Parse JHOVE XML output to extract:
- `<status>` → valid/not-valid/not-well-formed
- `<format>` → "TIFF"
- `<version>` → TIFF version
- `<message severity="error">` → errors
- `<message severity="warning">` → warnings

## Common TIFF Issues Detected

- Invalid IFD structure
- Missing required tags
- Invalid tag values
- Compression issues
- Color space problems

## Performance

- Target: <10 seconds per image average
- **Batch multiple files per JHOVE invocation** to reduce JVM startup overhead
- Optional: parallel worker pool (2-4 workers) for large batches (>1000 files)

### Batching Strategy

```typescript
// Batch 20-50 files per JHOVE call to amortize JVM startup
const BATCH_SIZE = 30;

async function validateBatch(files: string[]): Promise<JhoveResult[]> {
  const chunks = chunkArray(files, BATCH_SIZE);
  const results: JhoveResult[] = [];

  for (const chunk of chunks) {
    // Single JHOVE call for multiple files
    const xml = await exec(`jhove -h xml -m TIFF-hul ${chunk.join(' ')}`);
    results.push(...parseMultiFileXml(xml));
  }
  return results;
}
```

### Optional Parallelization

For large batches, use worker pool:
```typescript
const pool = new WorkerPool(4); // 4 parallel JHOVE processes
const results = await pool.map(chunks, validateChunk);
```

## Error Handling

- JHOVE not installed → throw with install instructions
- Timeout → return as error (don't throw)
- Non-TIFF file → return error result
- Corrupt file → return error result

## Success Criteria
- [ ] Validate TIFF files
- [ ] Parse XML output correctly
- [ ] Handle valid and invalid TIFFs
- [ ] Check JHOVE installation
- [ ] Performance: <10s per image
- [ ] Unit tests with valid/invalid fixtures

## Dependencies
- PRD 1.1 (project setup)
- **External: JHOVE CLI installed**
