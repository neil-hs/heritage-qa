# PRD 3.1: ExifTool Wrapper

## Overview
TypeScript wrapper for ExifTool CLI to extract EXIF metadata from images.

## Deliverables
- `src/extraction/exiftool.ts`

## Interface

```typescript
export interface ExifToolResult {
  success: boolean;
  data?: ExifData;
  error?: string;
  rawOutput?: string;
}

export interface ExifToolOptions {
  timeout?: number; // ms, default 30000
  tags?: string[]; // specific tags to extract, default all
}

export async function extractExif(
  filepath: string,
  options?: ExifToolOptions
): Promise<ExifToolResult>;

export async function extractExifBatch(
  filepaths: string[],
  options?: ExifToolOptions
): Promise<Map<string, ExifToolResult>>;

export async function isExifToolInstalled(): Promise<boolean>;
export async function getExifToolVersion(): Promise<string>;
```

## ExifTool Command

```bash
# Single file (JSON output)
exiftool -json -G1 -n /path/to/image.tif

# Batch via argfile (avoids OS command line length limits)
exiftool -json -G1 -n -@ filelist.txt
```

Flags:
- `-json`: JSON output
- `-G1`: Include group names (EXIF, IFD0, etc.)
- `-n`: Numeric values (no conversion)
- `-@ argfile`: Read file paths from file (one per line) - **required for large batches**

## Argfile Strategy

For batches >50 files, write paths to temp file and use `-@`:
```typescript
async function extractExifBatch(filepaths: string[]) {
  const argfile = await Bun.write(tempPath, filepaths.join('\n'));
  const result = await exec(`exiftool -json -G1 -n -@ ${argfile}`);
  await unlink(argfile);
  return parseResults(result);
}
```

This avoids "Argument list too long" errors on large batches or deep paths.

## Key EXIF Tags to Extract

```typescript
const CORE_TAGS = [
  'ImageWidth', 'ImageHeight',
  'BitsPerSample', 'SamplesPerPixel',
  'PhotometricInterpretation',
  'Compression',
  'ColorSpace', 'ICCProfileName',
  'Make', 'Model', 'LensModel',
  'Artist', 'Copyright',
  'DateTime', 'DateTimeOriginal',
  'Software'
];
```

## Error Handling
- ExifTool not installed → throw with install instructions
- Timeout → return error result
- Unreadable file → return error result (don't throw)
- Invalid image → return error result

## Success Criteria
- [ ] Extract EXIF from TIFF files
- [ ] Extract EXIF from RAW files (DNG, ARW, NEF, CR2, CR3)
- [ ] Batch extraction 100 files in <30s
- [ ] Handle missing/corrupt files gracefully
- [ ] Check ExifTool installation
- [ ] Unit tests with fixture images

## Dependencies
- PRD 1.1 (project setup)
- PRD 1.3 (ExifData type)
- **External: ExifTool CLI installed**
