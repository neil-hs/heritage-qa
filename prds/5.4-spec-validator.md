# PRD 5.4: Spec Validator (Orchestrator)

## Overview
Main validator that orchestrates all spec checks and stores results.

## Deliverables
- `src/validation/spec-validator.ts`

## Interface

```typescript
export interface SpecValidationResult {
  imageId: number;
  filepath: string;
  passed: boolean;
  checks: {
    dimension?: DimensionCheckResult;
    color?: ColorCheckResult;
    exifTags?: ExifTagCheckResult;
    jhove?: JhoveResult;
    raw?: RawValidationResult;
  };
  summary: {
    total: number;
    passed: number;
    failed: number;
    critical: number;
    fixable: number;
    warnings: number;
  };
}

export async function validateImage(
  db: Database,
  image: ImageInfo,
  spec: ProjectSpec
): Promise<SpecValidationResult>;

export async function validateBatch(
  db: Database,
  images: ImageInfo[],
  spec: ProjectSpec,
  options?: {
    runJhove?: boolean;
    onProgress?: (state: ProgressState) => void;
  }
): Promise<{
  results: SpecValidationResult[];
  summary: ValidationSummary;
}>;
```

## Orchestration Flow

```
1. Get image from DB (with EXIF data)
2. Run applicable validators:
   - If TIFF & run_jhove → JHOVE validation
   - If RAW & check_raw_validity → RAW validation
   - If dimensions spec → dimension validation
   - If color spec → color validation
   - If required_exif → EXIF tag validation
3. Aggregate results
4. Store in validation_results table
5. Return summary
```

## Check Applicability

```typescript
const checks = {
  jhove: spec.validation.run_jhove && image.fileType === 'TIFF',
  raw: spec.validation.check_raw_validity && image.fileType === 'RAW',
  dimension: !!spec.dimensions,
  color: !!spec.color,
  exifTags: spec.required_exif && spec.required_exif.length > 0
};
```

## Database Storage

For each check result:
```typescript
await insertValidationResult(db, {
  imageId: image.id,
  runId: currentRun.id,
  checkType: 'dimension',
  status: result.passed ? 'pass' : 'fail',
  severity: result.failures[0]?.severity,
  message: formatMessage(result.failures),
  details: JSON.stringify(result)
});
```

## Summary Aggregation

```typescript
interface ValidationSummary {
  runId: number;
  version: number;
  total: number;
  passed: number;
  failed: number;
  bySeverity: {
    critical: number;
    fixable: number;
    warning: number;
  };
  byCheck: {
    dimension: { pass: number; fail: number };
    color: { pass: number; fail: number };
    exifTags: { pass: number; fail: number };
    jhove: { pass: number; fail: number };
    raw: { pass: number; fail: number };
  };
}
```

## Success Criteria
- [ ] Orchestrates all validators
- [ ] Stores results in DB
- [ ] Correct summary aggregation
- [ ] Handles mixed TIFF/RAW batches
- [ ] Progress tracking
- [ ] Performance: 5,000 images in <1 min (spec only, no JHOVE)
- [ ] Integration tests

## Dependencies
- PRD 1.2 (database)
- PRD 1.4 (progress)
- PRD 5.1 (dimensions)
- PRD 5.2 (color)
- PRD 5.3 (EXIF tags)
- PRD 4.1 (JHOVE - optional)
- PRD 4.2 (RAW validator - optional)
