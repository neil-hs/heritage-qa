# PRD 9.2: Integration Tests & E2E Workflow

## Overview
End-to-end tests verifying complete validation workflows.

## Deliverables
- `tests/integration/full-workflow.test.ts`
- `tests/integration/multi-directory.test.ts`
- `tests/fixtures/` - Test images and configs
- Performance benchmarks

## Test Fixtures

```
tests/fixtures/
├── images/
│   ├── valid/
│   │   ├── valid_tiff_16bit.tif
│   │   ├── valid_tiff_8bit.tif
│   │   └── valid_dng.dng
│   ├── invalid/
│   │   ├── corrupt_tiff.tif
│   │   ├── wrong_dimensions.tif
│   │   ├── missing_exif.tif
│   │   └── wrong_bitdepth.tif
│   └── mixed/
│       ├── file1.tif
│       ├── file2.dng
│       └── file3.jpg
├── configs/
│   ├── basic-test.yaml
│   ├── strict-test.yaml
│   └── invalid-test.yaml
└── expected/
    ├── basic-results.json
    └── strict-results.json
```

## Integration Test Cases

### 1. Full TIFF Workflow
```typescript
test('validates TIFF images end-to-end', async () => {
  // Setup
  const projectDir = await createTempProject();
  await copyFixtures(projectDir, 'valid');
  await writeConfig(projectDir, 'basic');

  // Execute
  const result = await runValidation(projectDir);

  // Verify
  expect(result.total).toBe(3);
  expect(result.passed).toBe(3);
  expect(fs.existsSync(`${projectDir}/reports/validation_report_v1.html`)).toBe(true);
});
```

### 2. Mixed Pass/Fail
```typescript
test('correctly identifies failures', async () => {
  const projectDir = await createTempProject();
  await copyFixtures(projectDir, 'invalid');

  const result = await runValidation(projectDir);

  expect(result.failed).toBe(4);
  expect(result.bySeverity.critical).toBeGreaterThan(0);
  expect(result.bySeverity.fixable).toBeGreaterThan(0);
});
```

### 3. RAW File Validation
```typescript
test('validates RAW files without JHOVE', async () => {
  const projectDir = await createTempProject();
  await writeConfig(projectDir, 'raw-only');

  const result = await runValidation(projectDir);

  // JHOVE should not have been called
  expect(result.checks.jhove).toBeUndefined();
  expect(result.checks.raw).toBeDefined();
});
```

### 4. Resume After Interruption
```typescript
test('resumes from checkpoint', async () => {
  const projectDir = await createTempProject();

  // Start validation
  const progress = startValidation(projectDir);
  await waitForProgress(progress, 50); // 50%

  // Simulate interruption
  await interrupt(progress);

  // Resume
  const result = await resumeValidation(projectDir);

  expect(result.total).toBe(expectedTotal);
  expect(result.skipped).toBeGreaterThan(0); // Already processed
});
```

### 5. Multi-Directory
```typescript
test('handles multiple directories', async () => {
  const projectDir = await createTempProject();
  await setupMultiDir(projectDir, ['raw', 'deliverable']);

  const rawResult = await runValidation(`${projectDir}/raw`);
  const tiffResult = await runValidation(`${projectDir}/deliverable`);

  // Each has independent results
  expect(rawResult.config.format.file_type).toBe('RAW');
  expect(tiffResult.config.format.file_type).toBe('TIFF');
});
```

## Performance Benchmarks

```typescript
benchmark('EXIF extraction 1000 images', async () => {
  const result = await extractBatch(thousandImages);
  expect(result.duration).toBeLessThan(10 * 60 * 1000); // <10 min
});

benchmark('spec validation 5000 images', async () => {
  const result = await validateSpecs(fiveThousandImages);
  expect(result.duration).toBeLessThan(60 * 1000); // <1 min
});
```

## Test Utilities

```typescript
// tests/utils/test-helpers.ts
export async function createTempProject(): Promise<string>;
export async function copyFixtures(dir: string, set: string): Promise<void>;
export async function writeConfig(dir: string, template: string): Promise<void>;
export async function runValidation(dir: string): Promise<ValidationResult>;
export async function cleanupProject(dir: string): Promise<void>;
```

## Success Criteria
- [ ] All workflows tested end-to-end
- [ ] Fixture images for all scenarios
- [ ] Performance benchmarks pass
- [ ] Resume capability verified
- [ ] Multi-directory tested
- [ ] CI/CD integration

## Dependencies
- All implementation PRDs complete
